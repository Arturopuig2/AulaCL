{% extends "layout.html" %}

{% block content %}
<div style="max-width: 400px; margin: 0 auto; padding-top: 1rem;">
    <div class="glass-panel" style="padding: 2rem;">
        <h2 style="text-align: center;">Registro</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="name">Nombre</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="email">Correo Electr칩nico</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="confirm_email">Repetir Correo Electr칩nico</label>
                <input type="email" id="confirm_email" required>
            </div>

            <div class="form-group">
                <label for="password">Contrase침a</label>
                <div style="position: relative;">
                    <input type="text" id="password" required style="width: 100%; padding-right: 2.5rem;">
                    <span id="toggle-password"
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem;">游냣</span>
                </div>
            </div>

            <div class="form-group">
                <label for="confirm_password">Repetir Contrase침a</label>
                <div style="position: relative;">
                    <input type="text" id="confirm_password" required style="width: 100%; padding-right: 2.5rem;">
                    <span id="toggle-confirm-password"
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem;">游냣</span>
                </div>
            </div>


            <button type="submit" class="btn btn-primary" style="width: 100%;">Registrarse</button>
        </form>
        <p style="margin-top: 1rem; text-align: center; font-size: 0.9rem;">
            쯏a tienes cuenta? <a href="/login" style="color: var(--primary-color);">Inicia Sesi칩n</a>
        </p>
    </div>
</div>

<script>
    function setupPasswordToggle(toggleId, inputId) {
        document.getElementById(toggleId).addEventListener('click', function () {
            const passwordInput = document.getElementById(inputId);
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? '游뗻' : '游냣';
        });
    }

    setupPasswordToggle('toggle-password', 'password');
    setupPasswordToggle('toggle-confirm-password', 'confirm_password');

    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const email = document.getElementById('email').value;
        const confirmEmail = document.getElementById('confirm_email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirm_password').value;


        if (email !== confirmEmail) {
            alert('Los correos electr칩nicos no coinciden.');
            return;
        }

        if (password !== confirmPassword) {
            alert('Las contrase침as no coinciden. Por favor verif칤calas.');
            return;
        }


        try {
            // 1. Register User (Send email as username)
            await axios.post('/auth/register', {
                username: email,
                name: name,
                email: email,
                password: password
            });

            // 2. Auto-Login
            const formData = new FormData();
            formData.append('username', email);
            formData.append('password', password);

            const loginResponse = await axios.post('/auth/token', formData);

            // 3. Store Token and Redirect
            localStorage.setItem('token', loginResponse.data.access_token);
            localStorage.setItem('username', email);

            // alert('Registro exitoso. Redirigiendo...'); // Optional: removed for seamless experience
            window.location.href = '/dashboard';

        } catch (error) {
            console.error(error);
            alert('Error de registro/login: ' + (error.response?.data?.detail || error.message));
        }
    });
</script>
{% endblock %}