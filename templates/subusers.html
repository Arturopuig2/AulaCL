{% extends "layout.html" %}

{% block navbar_actions %}
<a href="/dashboard" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">← Panel</a>
{% endblock %}

{% block content %}
<div class="glass-panel" style="padding: 2rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h1 style="margin: 0; font-size: 1.8rem;">Mis Alumnos/as</h1>
        <button onclick="openAddSubUserModal()" class="btn btn-outline"
            style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
            + Alumno/a
        </button>
    </div>

    <!-- Sub-users List -->
    <div id="subusers-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
        <!-- Subusers cards loaded here -->
        <p style="text-align: center; color: var(--text-secondary);">Cargando...</p>
    </div>
</div>

<!-- Add SubUser Modal -->
<div id="add-subuser-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%;">
        <h2 style="margin-bottom: 1rem; text-align: center;">Crear Alumno/a</h2>
        <form id="add-subuser-form">
            <input type="text" id="subuser-name" placeholder="Nombre (Ej: Pepito)" required
                style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; margin-bottom: 1rem;">
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">Crear</button>
            <button type="button" onclick="closeAddSubUserModal()" class="btn btn-outline"
                style="width: 100%;">Cancelar</button>
        </form>
    </div>
</div>

<!-- Edit SubUser Modal -->
<div id="edit-subuser-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 450px; width: 90%;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.5rem;">Editar Perfil</h2>
            <button onclick="closeEditSubUserModal()"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <!-- Name Edit Section -->
        <div style="margin-bottom: 2rem;">
            <label style="font-size: 0.9rem; margin-bottom: 0.3rem;">Nombre del Alumno/a</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" id="edit-subuser-name"
                    style="flex: 1; padding: 0.6rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
                <button onclick="saveSubUserName()" class="btn btn-primary"
                    style="padding: 0.6rem 1rem;">Guardar</button>
            </div>
        </div>

        <div style="height: 1px; background: #e2e8f0; margin-bottom: 1.5rem;"></div>

        <!-- License Section -->
        <div style="margin-bottom: 2rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Licencia y Acceso</h3>
            <div id="edit-license-status" style="margin-bottom: 1rem; font-size: 0.9rem;"></div>
            <button id="edit-license-btn" class="btn btn-outline" style="width: 100%;">
                Activar / Extender Licencia
            </button>
        </div>

        <div style="height: 1px; background: #e2e8f0; margin-bottom: 1.5rem;"></div>

        <!-- Delete Section -->
        <div>
            <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem; color: #ef4444;">Zona de Peligro</h3>
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                El alumnado borrado no se puede recuperar.
            </p>
            <button id="edit-delete-btn" class="btn"
                style="width: 100%; background: #fee2e2; color: #ef4444; border: 1px solid #fca5a5;">
                Eliminar Alumno/a
            </button>
        </div>
    </div>
</div>

<!-- Activate License Modal (SubUser) -->
<div id="subuser-license-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%;">
        <h2 style="margin-bottom: 1rem; text-align: center;">Activar Licencia</h2>
        <p id="subuser-target-name" style="text-align: center; color: var(--text-secondary); margin-bottom: 1rem;"></p>
        <form id="subuser-license-form">
            <input type="hidden" id="target-subuser-id">
            <input type="text" id="subuser-license-key" placeholder="XXXXXXXXX" onfocus="this.placeholder=''"
                onblur="this.placeholder='XXXXXXXXX'" required
                style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center; text-transform: uppercase; letter-spacing: 1px;">
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">Activar y Generar
                Código</button>
            <button type="button" onclick="closeSubUserLicenseModal()" class="btn btn-outline"
                style="width: 100%;">Cancelar</button>
        </form>
    </div>
</div>

<!-- Show Code Modal -->
<div id="show-code-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%; text-align: center;">
        <h2 style="margin-bottom: 0.5rem; color: #22c55e;">¡Licencia Activada!</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Guarda este código. Es la <strong>ÚNICA</strong>
            forma de acceso para este usuario.</p>

        <div style="background: #f1f5f9; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
            <div id="generated-code-display"
                style="font-family: monospace; font-size: 2rem; font-weight: bold; letter-spacing: 2px; color: var(--primary-color);">
            </div>
        </div>

        <button type="button" onclick="closeShowCodeModal()" class="btn btn-primary" style="width: 100%;">Entendido, lo
            he guardado</button>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2200; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%; border: 2px solid #ef4444;">
        <h2 style="margin-bottom: 1rem; text-align: center; color: #ef4444;">⚠️ ADVERTENCIA SERIA</h2>
        <p style="text-align: center; color: var(--text-primary); margin-bottom: 1.5rem;">
            Estás a punto de eliminar al alumno/a <strong id="delete-target-name"></strong>.
        </p>
        <p style="text-align: center; color: #b91c1c; font-weight: 500; margin-bottom: 2rem;">
            Esta acción borrará TODO su progreso y resultados de forma PERMANENTE e IRREVERSIBLE.
            <br><br>
            ¿Estás completamente seguro/a?
        </p>

        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <button onclick="confirmDeleteAction()" class="btn"
                style="background: #ef4444; color: white; border: none; width: 100%;">
                SÍ, ELIMINAR ALUMNO/A
            </button>
            <button onclick="closeDeleteConfirmModal()" class="btn btn-outline" style="width: 100%;">
                Cancelar
            </button>
        </div>
    </div>
</div>

<script>
    async function loadSubUsers() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }
        axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;

        try {
            const response = await axios.get('/subusers/');
            const subusers = response.data;
            const container = document.getElementById('subusers-list');
            container.innerHTML = '';

            subusers.forEach(u => {
                const isActive = u.access_expires_at && new Date(u.access_expires_at) > new Date();
                const statusHtml = isActive
                    ? `<span style="color: #22c55e; font-size: 0.85rem; font-weight: 300;">Premium hasta ${new Date(u.access_expires_at).toLocaleDateString()}</span>`
                    : `<span style="color: #f59e0b; font-size: 0.85rem; font-weight: 500;">Acceso Limitado</span>`;

                const card = document.createElement('div');
                card.style.cssText = "display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem;";

                // Icon button style
                const btnColor = isActive ? 'var(--text-secondary)' : 'var(--primary-color)';
                const btnBorder = isActive ? '#cbd5e1' : 'var(--primary-color)';

                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button onclick='openEditSubUserModal(${JSON.stringify(u)})' 
                                class="btn btn-outline" 
                                style="padding: 0.2rem 0.6rem; font-size: 0.85rem; border-radius: 0.5rem;">
                            Editar
                        </button>
                        <h3 style="margin: 0; font-size: 1rem;">${u.name}</h3>
                        ${u.login_code_display ? `<span style="font-family: monospace; letter-spacing: 1px; background: #e2e8f0; padding: 0.2rem 0.6rem; border-radius: 0.25rem; font-size: 0.9rem; margin-left: 0.5rem; color: var(--text-secondary);">${u.login_code_display}</span>` : ''}
                    </div>
                    <div>
                        ${statusHtml}
                    </div>
                `;
                container.appendChild(card);
            });

            if (subusers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">No tienes alumnos/as creados.</p>';
            }
        } catch (error) {
            console.error("Error loading subusers", error);
            if (error.response && error.response.status === 401) window.location.href = '/login';
        }
    }

    // Modal helpers
    function openAddSubUserModal() { document.getElementById('add-subuser-modal').style.display = 'flex'; }
    function closeAddSubUserModal() { document.getElementById('add-subuser-modal').style.display = 'none'; }

    function openSubUserLicenseModal(id, name, isActive) {
        document.getElementById('target-subuser-id').value = id;
        document.getElementById('subuser-target-name').innerText = `Para: ${name}`;

        const btn = document.querySelector('#subuser-license-form button[type="submit"]');
        if (isActive) {
            btn.innerText = "Extender";
        } else {
            btn.innerText = "Activar y Generar Código";
        }

        document.getElementById('subuser-license-modal').style.display = 'flex';
    }
    function closeSubUserLicenseModal() { document.getElementById('subuser-license-modal').style.display = 'none'; }

    function closeShowCodeModal() {
        document.getElementById('show-code-modal').style.display = 'none';
        loadSubUsers(); // Refresh status
    }

    // Delete Logic
    let subUserToDeleteId = null;

    function confirmDeleteSubUser(id, name) {
        subUserToDeleteId = id;
        document.getElementById('delete-target-name').innerText = name;
        document.getElementById('delete-confirm-modal').style.display = 'flex';
    }

    function closeDeleteConfirmModal() {
        document.getElementById('delete-confirm-modal').style.display = 'none';
        subUserToDeleteId = null;
    }

    async function confirmDeleteAction() {
        if (!subUserToDeleteId) return;

        try {
            await axios.delete(`/subusers/${subUserToDeleteId}`);
            closeDeleteConfirmModal();
            loadSubUsers();
        } catch (error) {
            console.error(error);
            alert('Error al eliminar: ' + (error.response?.data?.detail || error.message));
        }
    }

    // Event Listeners
    document.getElementById('add-subuser-modal').onclick = (e) => { if (e.target === document.getElementById('add-subuser-modal')) closeAddSubUserModal(); };
    document.getElementById('subuser-license-modal').onclick = (e) => { if (e.target === document.getElementById('subuser-license-modal')) closeSubUserLicenseModal(); };

    document.getElementById('add-subuser-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('subuser-name').value;
        try {
            await axios.post('/subusers/', { name: name });
            closeAddSubUserModal();
            loadSubUsers();
            document.getElementById('subuser-name').value = ''; // Reset
        } catch (error) {
            alert('Error: ' + (error.response?.data?.detail || "Error al crear alumno/a"));
        }
    });

    document.getElementById('subuser-license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('target-subuser-id').value;
        const key = document.getElementById('subuser-license-key').value.trim();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.innerText = "Activando...";

        try {
            const response = await axios.post(`/subusers/${id}/license`, { license_key: key });

            // Success: Show code
            closeSubUserLicenseModal();
            document.getElementById('generated-code-display').innerText = response.data.login_code;
            document.getElementById('show-code-modal').style.display = 'flex';
            document.getElementById('subuser-license-key').value = ''; // Reset

        } catch (error) {
            alert('Error: ' + (error.response?.data?.detail || "Error al activar licencia"));
        } finally {
            if (btn.innerText === "Activando...") {
                btn.innerText = "Activar / Extender";
            }
        }
    });

    // Edit Modal Logic
    let currentEditingSubUser = null;

    function openEditSubUserModal(subuser) {
        currentEditingSubUser = subuser; // Store full object
        document.getElementById('edit-subuser-name').value = subuser.name;

        // Status Logic
        const isActive = subuser.access_expires_at && new Date(subuser.access_expires_at) > new Date();
        const statusDiv = document.getElementById('edit-license-status');

        if (isActive) {
            statusDiv.innerHTML = `<span style="color: #22c55e;">✅ Licencia Activa hasta ${new Date(subuser.access_expires_at).toLocaleDateString()}</span>`;
            document.getElementById('edit-license-btn').innerText = "Extender Licencia";
        } else {
            statusDiv.innerHTML = `<span style="color: #f59e0b;">⚠️ Acceso Limitado (Sin Licencia)</span>`;
            document.getElementById('edit-license-btn').innerText = "Activar Licencia";
        }

        // Bind Buttons
        document.getElementById('edit-license-btn').onclick = () => {
            closeEditSubUserModal();
            openSubUserLicenseModal(subuser.id, subuser.name, isActive);
        };

        document.getElementById('edit-delete-btn').onclick = () => {
            closeEditSubUserModal();
            confirmDeleteSubUser(subuser.id, subuser.name);
        };

        document.getElementById('edit-subuser-modal').style.display = 'flex';
    }

    function closeEditSubUserModal() {
        document.getElementById('edit-subuser-modal').style.display = 'none';
        currentEditingSubUser = null;
    }

    async function saveSubUserName() {
        if (!currentEditingSubUser) return;
        const newName = document.getElementById('edit-subuser-name').value;
        if (!newName.trim()) return alert("El nombre no puede estar vacío");

        try {
            await axios.put(`/subusers/${currentEditingSubUser.id}`, { name: newName });
            // Update local object to reflect change immediately if needed, or just reload
            closeEditSubUserModal();
            loadSubUsers();
        } catch (error) {
            console.error(error);
            alert('Error al actualizar nombre: ' + (error.response?.data?.detail || error.message));
        }
    }

    // Modal BG Click
    document.getElementById('edit-subuser-modal').onclick = (e) => {
        if (e.target === document.getElementById('edit-subuser-modal')) closeEditSubUserModal();
    };

    // Initial Load
    loadSubUsers();
</script>
{% endblock %}