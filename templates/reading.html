{% extends "layout.html" %}

{% block navbar_actions %}
<a href="/dashboard" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">← Home</a>
{% endblock %}

{% block content %}

<div class="glass-panel" style="padding: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div>
            <h1 id="text-title" style="margin: 0;">Cargando...</h1>
        </div>
        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
            ⏱ <span id="timer">00:00</span>
        </div>
    </div>

    <div style="margin-bottom: 2rem;">
        <audio id="audio-player" controls style="width: 100%; display: none;">
            <source id="audio-source" src="" type="audio/mpeg">
            Tu navegador no soporta audio.
        </audio>
    </div>

    <div id="text-content"
        style="background: white; padding: 2rem; border-radius: var(--radius); line-height: 1.8; font-size: 1.1rem; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); max-height: 60vh; overflow-y: auto;">
        Cargando texto...
    </div>

    <div style="margin-top: 2rem; text-align: right;">
        <button id="finish-btn" class="btn btn-primary">Terminar Lectura e Ir a Preguntas</button>
    </div>
</div>

<script>
    const textId = parseInt("{{ text_id }}");
    let startTime;
    let timerInterval;

    function updateTimer() {
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
        const seconds = (diff % 60).toString().padStart(2, '0');
        document.getElementById('timer').innerText = `${minutes}:${seconds}`;
    }

    async function loadText() {
        const token = localStorage.getItem('token');
        axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;

        try {
            const response = await axios.get(`/reading/texts/${textId}`);
            const text = response.data;

            document.getElementById('text-title').innerText = text.title;

            // Content is now served by the API directly
            if (text.content) {
                document.getElementById('text-content').innerText = text.content;
            } else {
                document.getElementById('text-content').innerText = "No se pudo cargar el contenido.";
            }

            if (text.audio_path) {
                const audioPlayer = document.getElementById('audio-player');
                document.getElementById('audio-source').src = "/audio/" + text.audio_path;
                audioPlayer.load();
                audioPlayer.style.display = 'block';
            }

            // Start Timer
            startTime = new Date();
            timerInterval = setInterval(updateTimer, 1000);

        } catch (error) {
            console.error(error);
            alert("Error cargando el texto");
        }
    }

    document.getElementById('finish-btn').addEventListener('click', () => {
        clearInterval(timerInterval);
        const now = new Date();
        const timeSpent = (now - startTime) / 1000;

        // Store time spent to send later
        localStorage.setItem(`time_spent_${textId}`, timeSpent);

        window.location.href = `/quiz/${textId}`;
    });

    loadText();
</script>
{% endblock %}