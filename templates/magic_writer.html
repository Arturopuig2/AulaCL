{% extends "layout.html" %}

{% block navbar_actions %}
<a href="/admin" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">‚Üê Volver a Admin</a>
{% endblock %}

{% block content %}
<h1 style="max-width: 1000px; margin: 0 auto 2rem auto;">Escritor M√°gico IA</h1>

<div style="max-width: 1000px; margin: 0 auto;">
    <div
        style="margin-bottom: 3rem; background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);">

        <!-- MAGIC CONFIG -->
        <div id="magic-config">
            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="magic-topic"
                    placeholder="Tema / Sinopsis (ej: Dos astronautas descubren una flor)" class="form-control">

                <select id="magic-course-select" class="form-control">
                    <option value="" disabled selected>Nivel / Curso</option>
                    <optgroup label="Primaria">
                        <option value="1P">1¬∫ Primaria</option>
                        <option value="2P">2¬∫ Primaria</option>
                        <option value="3P">3¬∫ Primaria</option>
                        <option value="4P">4¬∫ Primaria</option>
                        <option value="5P">5¬∫ Primaria</option>
                        <option value="6P">6¬∫ Primaria</option>
                    </optgroup>
                    <optgroup label="ESO">
                        <option value="1ESO">1¬∫ ESO</option>
                        <option value="2ESO">2¬∫ ESO</option>
                        <option value="3ESO">3¬∫ ESO</option>
                        <option value="4ESO">4¬∫ ESO</option>
                    </optgroup>
                    <optgroup label="Bachillerato">
                        <option value="1BAT">1¬∫ Bachillerato</option>
                        <option value="2BAT">2¬∫ Bachillerato</option>
                    </optgroup>
                    <option value="ALL">Sin Curso / General</option>
                </select>

                <input type="number" id="magic-words" placeholder="Palabras aprox (ej: 100)" class="form-control"
                    value="100">

                <select id="magic-lang" class="form-control">
                    <option value="es">Espa√±ol</option>
                    <option value="en">Ingl√©s</option>
                    <option value="val">Valenci√†</option>
                    <option value="fr">Franc√©s</option>
                </select>
            </div>

            <button onclick="generateMagicStory()" id="btn-magic-gen" class="btn btn-primary"
                style="width: 100%; height: 42px; background: #2563eb; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                ü™Ñ Generar Cuento
            </button>
        </div>

        <!-- MAGIC EDITOR -->
        <div id="magic-editor"
            style="display: none; margin-top: 2rem; border-top: 2px dashed #bfdbfe; padding-top: 2rem;">
            <h3 style="margin-bottom: 1rem; color: #1e40af;">Revisi√≥n y Edici√≥n</h3>

            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="font-weight: bold;">T√≠tulo</label>
                <input type="text" id="edit-title"
                    style="width: 100%; padding: 0.5rem; font-weight: bold; font-size: 1.1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
            </div>

            <div class="form-group" style="margin-bottom: 2rem;">
                <label style="font-weight: bold;">Historia</label>
                <textarea id="edit-content"
                    style="width: 100%; height: 300px; padding: 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: sans-serif; line-height: 1.6; font-size: 14px;"></textarea>
            </div>

            <h4
                style="margin-bottom: 1rem; color: #1e40af; display: flex; justify-content: space-between; align-items: center;">
                <span>Editar Preguntas</span>
                <button onclick="generateMagicQuestions()" id="btn-magic-questions" class="btn btn-outline"
                    style="font-size: 0.9rem; border-color: #3b82f6; color: #3b82f6;">
                    üöÄ Generar Preguntas (IA)
                </button>
            </h4>
            <div id="questions-container" style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                <!-- JS will popualte this -->
            </div>

            <div style="display: flex; gap: 1rem;">
                <button onclick="saveMagicStory()" id="btn-magic-save" class="btn btn-primary"
                    style="flex: 2; padding: 1rem; font-size: 1.1rem;">üíæ Guardar en Librer√≠a</button>
                <button onclick="cancelMagic()" class="btn btn-outline" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentMagicDraft = null;

    // Check Auth on Load
    (function checkAuth() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');
        if (!token || username !== 'admin') {
            window.location.href = '/dashboard';
            return;
        }
        axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;
    })();

    async function generateMagicStory() {
        const topic = document.getElementById('magic-topic').value;
        const course = document.getElementById('magic-course-select').value;
        const words = document.getElementById('magic-words').value;
        const lang = document.getElementById('magic-lang').value;

        if (!topic) {
            alert("Por favor, rellena el tema.");
            return;
        }

        const btn = document.getElementById('btn-magic-gen');
        const originalText = btn.innerText;
        btn.innerText = "‚ú® Escribiendo Historia... (Paso 1/2)";
        btn.disabled = true;

        try {
            // STEP 1: Generate Content Only
            const response = await axios.post('/reading/admin/magic/story', {
                topic: topic,
                course_level: course,
                word_count: parseInt(words),
                language: lang
            });

            currentMagicDraft = response.data; // now just {title, content}

            // Pre-fill empty questions for rendering logic if needed, or just init empty
            currentMagicDraft.questions = [];

            renderMagicEditor(currentMagicDraft);

            // UI Switch
            document.getElementById('magic-config').style.display = 'none';
            document.getElementById('magic-editor').style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("Error generando cuento: " + (error.response?.data?.detail || error.message));
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function renderMagicEditor(draft) {
        console.log("Rendering Draft:", draft); // Debugging
        document.getElementById('edit-title').value = draft.title;
        document.getElementById('edit-content').value = draft.content;

        const qContainer = document.getElementById('questions-container');
        qContainer.innerHTML = '';

        draft.questions.forEach((q, index) => {
            renderQuestionCard(q, index);
        });
    }

    function renderQuestionCard(q, index) {
        const qContainer = document.getElementById('questions-container');
        const card = document.createElement('div');
        card.style.background = '#f8fafc';
        card.style.padding = '1rem';
        card.style.border = '1px solid #e2e8f0';
        card.style.borderRadius = '0.5rem';

        // Generate HTML structure (values set via JS below for safety)
        card.innerHTML = `
            <div style="margin-bottom: 0.5rem; font-weight: bold; color: #475569;">Pregunta ${index + 1}</div>
            <input type="text" class="q-input" style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #94a3b8; border-radius: 4px; color: #1e293b; background: #ffffff;">
            
            <div style="display: grid; gap: 0.5rem; padding-left: 1rem;">
                ${q.options.map((_, optIndex) => `
                    <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: space-between;">
                        <input type="text" class="q-opt-input" data-q="${index}" data-opt="${optIndex}" placeholder="Escribe una opci√≥n..." 
                            onfocus="this.dataset.ph=this.placeholder;this.placeholder=''" 
                            onblur="this.placeholder=this.dataset.ph"
                            style="flex: 1; padding: 0.5rem; border: 1px solid #94a3b8; border-radius: 4px; color: #1e293b; background: #ffffff; min-width: 0; margin-right: 0.5rem;">
                        <input type="radio" name="q-correct-${index}" value="${optIndex}" ${q.correct_index === optIndex ? 'checked' : ''} style="width: 24px; height: 24px; flex-shrink: 0; cursor: pointer;">
                    </div>
                `).join('')}
            </div>
        `;

        // Set values safely via DOM properties (avoids all escaping issues)
        card.querySelector('.q-input').value = q.question;
        const optInputs = card.querySelectorAll('.q-opt-input');
        q.options.forEach((opt, i) => {
            const safeOpt = (opt === null || opt === undefined) ? "" : opt;
            if (optInputs[i]) optInputs[i].value = safeOpt;
        });

        qContainer.appendChild(card);
    }

    async function generateMagicQuestions() {
        const content = document.getElementById('edit-content').value;
        const topic = document.getElementById('edit-title').value; // Optional context

        if (!content || content.length < 50) {
            alert("El texto es demasiado corto para generar preguntas.");
            return;
        }

        const btn = document.getElementById('btn-magic-questions');
        const originalText = btn.innerText;
        btn.innerText = "üß† Pensando preguntas...";
        btn.disabled = true;

        try {
            const response = await axios.post('/reading/admin/magic/questions', {
                content: content,
                topic: topic
            });

            const questions = response.data.questions;
            const qContainer = document.getElementById('questions-container');
            qContainer.innerHTML = ''; // Clear previous if any

            questions.forEach((q, index) => {
                renderQuestionCard(q, index);
            });

        } catch (error) {
            console.error(error);
            alert("Error generando preguntas: " + (error.response?.data?.detail || error.message));
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function saveMagicStory() {
        if (!currentMagicDraft) return;

        const btn = document.getElementById('btn-magic-save');
        btn.innerText = "Guardando...";
        btn.disabled = true;

        try {
            // 1. Collect Data
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;
            // Magic Page only has one course selector now
            const courseSelect = document.getElementById('magic-course-select');
            const course = courseSelect.value;
            const lang = document.getElementById('magic-lang').value;

            // 2. Reconstruct Questions
            const questions = [];
            const qContainer = document.getElementById('questions-container');

            for (let i = 0; i < qContainer.children.length; i++) {
                const card = qContainer.children[i];
                const qText = card.querySelector('.q-input').value;

                const optInputs = card.querySelectorAll('.q-opt-input');
                const options = Array.from(optInputs).map(input => input.value);

                const checkedRadio = card.querySelector(`input[name="q-correct-${i}"]:checked`);
                const correctIndex = checkedRadio ? parseInt(checkedRadio.value) : 0;

                questions.push({
                    question: qText,
                    options: options,
                    correct_index: correctIndex
                });
            }

            // 3. Send API
            await axios.post('/reading/admin/magic/save', {
                title: title,
                content: content,
                questions: questions,
                course_level: course,
                language: lang
            });

            alert("¬°Cuento guardado correctamente! üìö");
            cancelMagic();
            // Optional: Redirect back to admin or stay here? 
            // Staying here is fine for generating another one.

        } catch (error) {
            console.error(error);
            alert("Error guardando: " + (error.response?.data?.detail || error.message));
        } finally {
            btn.innerText = "üíæ Guardar en Librer√≠a";
            btn.disabled = false;
        }
    }

    function cancelMagic() {
        document.getElementById('magic-config').style.display = 'block';
        document.getElementById('magic-editor').style.display = 'none';
        currentMagicDraft = null;
        document.getElementById('edit-title').value = '';
        document.getElementById('edit-content').value = '';
        document.getElementById('questions-container').innerHTML = '';
        document.getElementById('magic-topic').value = ''; // Clean topic too
    }
</script>
{% endblock %}