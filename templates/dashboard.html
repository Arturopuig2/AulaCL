{% extends "layout.html" %}

{% block content %}
<div class="glass-panel" style="padding: 2rem; margin-bottom: 2rem;">
    <h1>Mi Panel - <span id="user-display"></span></h1>
    <p class="lead">Selecciona una lectura para comenzar.</p>

    <div id="prediction-card" class="card"
        style="background: #eff6ff; border-left: 4px solid var(--primary-color); margin-bottom: 1rem; display: none;">
        <h3>ðŸ”® PredicciÃ³n de Futuro</h3>
        <p id="prediction-text"></p>
    </div>
</div>

<div id="filters" style="margin-bottom: 2rem; display: flex; gap: 1.5rem; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 200px;">
        <label for="course-select" style="margin-bottom: 0.5rem; display: block; font-weight: 500;">Filtrar por
            Curso:</label>
        <select id="course-select" onchange="applyFilters()"
            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; font-size: 1rem; width: 100%;">
            <option value="all">Todos los cursos</option>
            <optgroup label="Primaria">
                <option value="1P">1Âº Primaria</option>
                <option value="2P">2Âº Primaria</option>
                <option value="3P">3Âº Primaria</option>
                <option value="4P">4Âº Primaria</option>
                <option value="5P">5Âº Primaria</option>
                <option value="6P">6Âº Primaria</option>
            </optgroup>
            <optgroup label="ESO">
                <option value="1ESO">1Âº ESO</option>
                <option value="2ESO">2Âº ESO</option>
                <option value="3ESO">3Âº ESO</option>
                <option value="4ESO">4Âº ESO</option>
            </optgroup>
            <optgroup label="Bachillerato">
                <option value="1BAT">1Âº Bachillerato</option>
                <option value="2BAT">2Âº Bachillerato</option>
            </optgroup>
            <option value="ALL">Sin Curso / General</option>
        </select>
    </div>

    <div style="flex: 1; min-width: 200px;">
        <label for="lang-select" style="margin-bottom: 0.5rem; display: block; font-weight: 500;">Filtrar por
            Idioma:</label>
        <select id="lang-select" onchange="applyFilters()"
            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; font-size: 1rem; width: 100%;">
            <option value="all">Todos los idiomas</option>
            <option value="es">EspaÃ±ol</option>
            <option value="val">ValenciÃ </option>
            <option value="cat">CatalÃ </option>
            <option value="gal">Gallego</option>
            <option value="eus">Euskera</option>
            <option value="en">InglÃ©s</option>
            <option value="fr">FrancÃ©s</option>
        </select>
    </div>
</div>

<div id="texts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
    <!-- Texts will be loaded here -->
</div>
</div>

<script>
    let allTexts = [];

    async function loadDashboard() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        document.getElementById('user-display').innerText = localStorage.getItem('username');
        axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;

        try {
            const response = await axios.get('/reading/texts');
            allTexts = response.data;
            renderTexts(allTexts);

            // Load Prediction (existing code)
            const predResponse = await axios.get('/reading/prediction');
            const pred = predResponse.data;
            if (pred.message && pred.message !== "Not enough data for prediction") {
                document.getElementById('prediction-card').style.display = 'block';
                const scoreOver10 = Math.round(pred.predicted_score / 10);
                document.getElementById('prediction-text').innerHTML = `
                    Basado en tus lecturas anteriores, predecimos que tu prÃ³xima puntuaciÃ³n serÃ¡ de: 
                    <strong>${scoreOver10} / 10</strong>. 
                `;
            } else if (pred.predicted_score > 0) {
                document.getElementById('prediction-card').style.display = 'block';
                const scoreOver10 = Math.round(pred.predicted_score / 10);
                document.getElementById('prediction-text').innerHTML = `
                     PredicciÃ³n de rendimiento futuro: <strong>${scoreOver10} / 10</strong>
                  `;
            }

        } catch (error) {
            if (error.response && error.response.status === 401) {
                window.location.href = '/login';
            }
            console.error(error);
        }
    }

    function renderTexts(texts) {
        const grid = document.getElementById('texts-grid');
        grid.innerHTML = '';
        texts.forEach(text => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <h3>${text.title}</h3>
                    ${text.is_completed ? `<div style="display: flex; align-items: center;"><span style="font-size: 0.85rem; color: var(--text-secondary); margin-right: 0.5rem; font-weight: 500;">${Math.round(text.score / 10)}/10</span><div style="width: 12px; height: 12px; background-color: #22c55e; border-radius: 50%;" title="Completado"></div></div>` : ''}
                </div>
                <div style="margin-bottom: 0.5rem;">
                    ${getCourseBadge(text.course_level)}
                    <span style="background: #e2e8f0; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem; color: var(--text-primary);">${getLangLabel(text.language)}</span>
                </div>
                <p style="color: var(--text-secondary); display: none;">Curso: ${text.course_level}</p>
                <a href="/reading-room/${text.id}" class="btn btn-primary" style="margin-top: 1rem; width: 100%; text-decoration: none; text-align: center;">Leer y Escuchar</a>
            `;
            grid.appendChild(card);
        });
    }

    function applyFilters() {
        const selectedLang = document.getElementById('lang-select').value;
        const selectedCourse = document.getElementById('course-select').value;

        const filtered = allTexts.filter(t => {
            const matchLang = selectedLang === 'all' || t.language === selectedLang;
            const matchCourse = selectedCourse === 'all' || t.course_level === selectedCourse;
            return matchLang && matchCourse;
        });

        renderTexts(filtered);
    }

    function getLangLabel(code) {
        const map = { 'es': 'EspaÃ±ol', 'en': 'InglÃ©s', 'val': 'ValenciÃ ', 'cat': 'CatalÃ ', 'fr': 'FrancÃ©s', 'gal': 'Gallego', 'eus': 'Euskera' };
        return map[code] || code || 'EspaÃ±ol';
    }

    function getCourseBadge(code) {
        const map = {
            '1P': '1Âº Primaria', '2P': '2Âº Primaria', '3P': '3Âº Primaria', '4P': '4Âº Primaria', '5P': '5Âº Primaria', '6P': '6Âº Primaria',
            '1ESO': '1Âº ESO', '2ESO': '2Âº ESO', '3ESO': '3Âº ESO', '4ESO': '4Âº ESO',
            'ALL': 'Sin Curso'
        };
        const label = map[code] || code;
        const color = code === 'ALL' ? '#94a3b8' : 'var(--primary-color)'; // Gray for ALL, Primary for others
        return `<span style="background: ${color}; color: white; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem; margin-right: 0.5rem;">${label}</span>`;
    }

    loadDashboard();
</script>
{% endblock %}