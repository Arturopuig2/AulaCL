{% extends "layout.html" %}

{% block content %}
<div class="glass-panel" style="padding: 2rem; margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1>Mi Panel - <span id="user-display"></span></h1>
            <p class="lead">Selecciona una lectura para comenzar.</p>
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
            <button id="unlock-btn" onclick="openUnlockModal()" class="btn btn-outline"
                style="display: none; border-color: var(--primary-color); color: var(--text-primary); background: rgba(255,255,255,0.8);">
                ðŸ”‘ Activar CÃ³digo Premium
            </button>
            <div id="subscription-status" style="font-size: 0.85rem; font-weight: 500; text-align: right;">
                <!-- Status will be loaded here -->
            </div>
        </div>
    </div>

    <div id="unlock-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
        <div class="glass-panel" onclick="event.stopPropagation()"
            style="background: white; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h2 style="margin-bottom: 1rem; text-align: center;">ðŸ”“ Desbloquear Todo</h2>
            <p style="text-align: center; margin-bottom: 1.5rem; color: var(--text-secondary);">Introduce tu cÃ³digo de
                invitaciÃ³n para acceder a todas las lecturas durante 1 aÃ±o.</p>
            <form id="unlock-form">
                <input type="text" id="unlock-code" placeholder="CÃ“DIGO (Ej: X9Y2Z1)" required
                    style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center; font-size: 1.1rem; letter-spacing: 2px; text-transform: uppercase;">
                <button type="submit" class="btn btn-primary"
                    style="width: 100%; margin-bottom: 0.5rem;">Activar</button>
                <button type="button" onclick="closeUnlockModal()" class="btn btn-outline"
                    style="width: 100%;">Cancelar</button>
            </form>
        </div>
    </div>

    <div id="prediction-card"
        style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; display: none; box-shadow: none !important; transform: none !important; transition: none !important;">
        <h3 style="margin-top: 0; font-size: 1.1rem; color: var(--text-primary);">ðŸ”® PredicciÃ³n de Futuro</h3>
        <p id="prediction-text" style="color: var(--text-secondary); margin-bottom: 0;"></p>
    </div>

    <!-- Sub-users Section (Initially Hidden) -->
    <div id="subusers-section"
        style="display: none; background: white; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0; font-size: 1.5rem;">Mis Sub-usuarios</h2>
            <button onclick="openAddSubUserModal()" class="btn btn-primary" style="font-size: 0.9rem;">
                + AÃ±adir Sub-usuario
            </button>
        </div>
        <div id="subusers-list"
            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
            <!-- Subusers cards loaded here -->
        </div>
    </div>
</div>

<!-- Add SubUser Modal -->
<div id="add-subuser-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%;">
        <h2 style="margin-bottom: 1rem; text-align: center;">Crear Sub-usuario</h2>
        <form id="add-subuser-form">
            <input type="text" id="subuser-name" placeholder="Nombre (Ej: Pepito)" required
                style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; margin-bottom: 1rem;">
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">Crear</button>
            <button type="button" onclick="closeAddSubUserModal()" class="btn btn-outline"
                style="width: 100%;">Cancelar</button>
        </form>
    </div>
</div>

<!-- Activate License Modal (SubUser) -->
<div id="subuser-license-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%;">
        <h2 style="margin-bottom: 1rem; text-align: center;">Activar Licencia</h2>
        <p id="subuser-target-name" style="text-align: center; color: var(--text-secondary); margin-bottom: 1rem;"></p>
        <form id="subuser-license-form">
            <input type="hidden" id="target-subuser-id">
            <input type="text" id="subuser-license-key" placeholder="LICENCIA (Ej: A1B2C3D4)" required
                style="width: 100%; padding: 0.8rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center; text-transform: uppercase; letter-spacing: 1px;">
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">Activar y Generar
                CÃ³digo</button>
            <button type="button" onclick="closeSubUserLicenseModal()" class="btn btn-outline"
                style="width: 100%;">Cancelar</button>
        </form>
    </div>
</div>

<!-- Show Code Modal -->
<div id="show-code-modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; align-items: center; justify-content: center; backdrop-filter: blur(2px);">
    <div class="glass-panel" onclick="event.stopPropagation()"
        style="background: white; padding: 2rem; max-width: 400px; width: 90%; text-align: center;">
        <h2 style="margin-bottom: 0.5rem; color: #22c55e;">Â¡Licencia Activada!</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Guarda este cÃ³digo. Es la <strong>ÃšNICA</strong>
            forma de acceso para este usuario.</p>

        <div style="background: #f1f5f9; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
            <div id="generated-code-display"
                style="font-family: monospace; font-size: 2rem; font-weight: bold; letter-spacing: 2px; color: var(--primary-color);">
            </div>
        </div>

        <button type="button" onclick="closeShowCodeModal()" class="btn btn-primary" style="width: 100%;">Entendido, lo
            he guardado</button>
    </div>
</div>

<div id="filters" style="margin-bottom: 2rem; display: flex; gap: 1.5rem; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 200px;">
        <label for="course-select" style="margin-bottom: 0.5rem; display: block; font-weight: 500;">Filtrar por
            Curso:</label>
        <select id="course-select" onchange="applyFilters()"
            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; font-size: 1rem; width: 100%;">
            <option value="all">Todos los cursos</option>
            <optgroup label="Primaria">
                <option value="1P">1Âº Primaria</option>
                <option value="2P">2Âº Primaria</option>
                <option value="3P">3Âº Primaria</option>
                <option value="4P">4Âº Primaria</option>
                <option value="5P">5Âº Primaria</option>
                <option value="6P">6Âº Primaria</option>
            </optgroup>
            <optgroup label="ESO">
                <option value="1ESO">1Âº ESO</option>
                <option value="2ESO">2Âº ESO</option>
                <option value="3ESO">3Âº ESO</option>
                <option value="4ESO">4Âº ESO</option>
            </optgroup>
            <optgroup label="Bachillerato">
                <option value="1BAT">1Âº Bachillerato</option>
                <option value="2BAT">2Âº Bachillerato</option>
            </optgroup>
            <option value="ALL">Sin Curso / General</option>
        </select>
    </div>

    <div style="flex: 1; min-width: 200px;">
        <label for="lang-select" style="margin-bottom: 0.5rem; display: block; font-weight: 500;">Filtrar por
            Idioma:</label>
        <select id="lang-select" onchange="applyFilters()"
            style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid #cbd5e1; font-size: 1rem; width: 100%;">
            <option value="all">Todos los idiomas</option>
            <option value="es">EspaÃ±ol</option>
            <option value="val">ValenciÃ </option>
            <option value="cat">CatalÃ </option>
            <option value="gal">Gallego</option>
            <option value="eus">Euskera</option>
            <option value="en">InglÃ©s</option>
            <option value="fr">FrancÃ©s</option>
        </select>
    </div>
</div>

<div id="texts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
    <!-- Texts will be loaded here -->
</div>
</div>

<script>
    let allTexts = [];

    async function loadDashboard() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        document.getElementById('user-display').innerText = localStorage.getItem('username');
        axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;

        try {
            // Load User Info (Premium Status)
            const userResponse = await axios.get('/auth/me');
            const user = userResponse.data;
            const statusDiv = document.getElementById('subscription-status');

            if (user.access_expires_at && new Date(user.access_expires_at) > new Date()) {
                const date = new Date(user.access_expires_at).toLocaleDateString();
                statusDiv.innerHTML = `
                    <div style="color: #22c55e;">Premium Activo</div>
                    <div style="font-size: 0.8em; color: var(--text-secondary); margin-top: 2px;">Caduca: ${date}</div>
                `;
            } else {
                statusDiv.innerHTML = `<span style="color: var(--text-secondary);">Modo Gratuito</span>`;
            }

            const response = await axios.get('/reading/texts');
            allTexts = response.data;
            renderTexts(allTexts);

            // 1. Get User Info
            // Checking if 'username' exists to determine if it is a Main User
            // SubUsers login via code and don't necessarily have a 'username' field mapped in schemas.User response
            // Schemas.User has 'username', SubUser schema does not.
            // But /auth/me returns different objects? 
            // Wait, /auth/me returns 'current_user' which is either User or SubUser object.

            if (user.username) {
                // Main User
                document.getElementById('subusers-section').style.display = 'block';
                loadSubUsers();
            } else {
                // Sub User
                document.getElementById('user-display').innerText = user.name || "Estudiante";
                // Hide specific elements if needed
            }

            // Load Prediction (existing code)
            const predResponse = await axios.get('/reading/prediction');
            const pred = predResponse.data;
            if (pred.message && pred.message !== "Not enough data for prediction") {
                document.getElementById('prediction-card').style.display = 'block';
                const scoreOver10 = Math.round(pred.predicted_score / 10);
                document.getElementById('prediction-text').innerHTML = `
                    Basado en tus lecturas anteriores, predecimos que tu prÃ³xima puntuaciÃ³n serÃ¡ de: 
                    <strong>${scoreOver10} / 10</strong>. 
                `;
            } else if (pred.predicted_score > 0) {
                document.getElementById('prediction-card').style.display = 'block';
                const scoreOver10 = Math.round(pred.predicted_score / 10);
                document.getElementById('prediction-text').innerHTML = `
                     PredicciÃ³n de rendimiento futuro: <strong>${scoreOver10} / 10</strong>
                  `;
            }

        } catch (error) {
            if (error.response && error.response.status === 401) {
                window.location.href = '/login';
            }
            console.error(error);
        }
    }

    function renderTexts(texts) {
        const grid = document.getElementById('texts-grid');
        grid.innerHTML = '';

        let hasLockedContent = false;

        texts.forEach(text => {
            if (text.is_locked) hasLockedContent = true;

            const card = document.createElement('div');
            card.className = 'card';

            // Locked Visuals
            const opacity = text.is_locked ? '0.6' : '1';
            const pointerEvents = text.is_locked ? 'none' : 'auto'; // Disable link click if locked (we handle wrapper click)
            const lockIcon = text.is_locked ? '<div style="position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem;">ðŸ”’</div>' : '';
            const blur = text.is_locked ? 'filter: grayscale(80%);' : '';

            card.style.cssText = `position: relative; ${blur}`;

            // If locked, clicking the card opens modal
            if (text.is_locked) {
                card.style.cursor = "pointer";
                card.onclick = (e) => {
                    e.preventDefault();
                    openUnlockModal();
                };
            }

            card.innerHTML = `
                ${lockIcon}
                <div style="display: flex; justify-content: space-between; align-items: start; opacity: ${opacity};">
                    <h3>${text.title}</h3>
                    ${text.is_completed ? `<div style="display: flex; align-items: center;"><span style="font-size: 0.85rem; color: var(--text-secondary); margin-right: 0.5rem; font-weight: 500;">${Math.round(text.score / 10)}/10</span><div style="width: 12px; height: 12px; background-color: #22c55e; border-radius: 50%;" title="Completado"></div></div>` : ''}
                </div>
                <div style="margin-bottom: 0.5rem; opacity: ${opacity};">
                    ${getCourseBadge(text.course_level)}
                    <span style="background: #e2e8f0; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem; color: var(--text-primary);">${getLangLabel(text.language)}</span>
                </div>
                <p style="color: var(--text-secondary); display: none;">Curso: ${text.course_level}</p>
                <a href="${text.is_locked ? '#' : '/reading-room/' + text.id}" class="btn btn-primary" style="margin-top: 1rem; width: 100%; text-decoration: none; text-align: center; opacity: ${opacity}; pointer-events: ${pointerEvents};">
                    ${text.is_locked ? 'Bloqueado' : 'Leer y Escuchar'}
                </a>
            `;
            grid.appendChild(card);
        });

        // Always show unlock button (to allow extension), but change text if needed
        const unlockBtn = document.getElementById('unlock-btn');
        if (unlockBtn) {
            unlockBtn.style.display = 'block';
            if (!hasLockedContent) {
                unlockBtn.innerHTML = 'Extender Premium';
                unlockBtn.classList.remove('btn-outline');
                unlockBtn.classList.add('btn-premium');

                // Clear inline overrides so CSS class works
                unlockBtn.style.background = '';
                unlockBtn.style.color = '';
                unlockBtn.style.borderColor = '';
            } else {
                unlockBtn.innerHTML = 'ðŸ”‘ Activar CÃ³digo Premium';
                unlockBtn.classList.add('btn-outline');
                unlockBtn.classList.remove('btn-premium');

                // Restore default inline looks
                unlockBtn.style.background = 'rgba(255,255,255,0.8)';
                unlockBtn.style.color = 'var(--text-primary)';
                unlockBtn.style.borderColor = 'var(--primary-color)';
            }
        }

        // If ALL content is unlocked (premium), maybe show a "Premium Active" badge?
        if (!hasLockedContent && texts.length > 0) {
            // Optional: Show premium badge
        }
    }

    // Modal Logic
    const modal = document.getElementById('unlock-modal');

    function openUnlockModal() {
        modal.style.display = 'flex';
    }

    function closeUnlockModal() {
        modal.style.display = 'none';
    }

    // Close on click outside
    modal.addEventListener('click', function (e) {
        if (e.target === modal) {
            closeUnlockModal();
        }
    });

    document.getElementById('unlock-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const code = document.getElementById('unlock-code').value.toUpperCase().trim();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.innerText = "Verificando...";

        try {
            const response = await axios.post('/auth/unlock', { access_code: code });
            alert(response.data.message);
            closeUnlockModal();
            loadDashboard(); // Reload to see unlocked content
        } catch (error) {
            alert('Error: ' + (error.response?.data?.detail || "CÃ³digo incorrecto"));
        } finally {
            btn.innerText = "Activar";
        }
    });

    // Existing Filters...
    function applyFilters() {
        const selectedLang = document.getElementById('lang-select').value;
        const selectedCourse = document.getElementById('course-select').value;

        const filtered = allTexts.filter(t => {
            const matchLang = selectedLang === 'all' || t.language === selectedLang;
            const matchCourse = selectedCourse === 'all' || t.course_level === selectedCourse;
            return matchLang && matchCourse;
        });

        renderTexts(filtered);
    }

    function getLangLabel(code) {
        const map = { 'es': 'EspaÃ±ol', 'en': 'InglÃ©s', 'val': 'ValenciÃ ', 'cat': 'CatalÃ ', 'fr': 'FrancÃ©s', 'gal': 'Gallego', 'eus': 'Euskera' };
        return map[code] || code || 'EspaÃ±ol';
    }

    function getCourseBadge(code) {
        const map = {
            '1P': '1Âº Primaria', '2P': '2Âº Primaria', '3P': '3Âº Primaria', '4P': '4Âº Primaria', '5P': '5Âº Primaria', '6P': '6Âº Primaria',
            '1ESO': '1Âº ESO', '2ESO': '2Âº ESO', '3ESO': '3Âº ESO', '4ESO': '4Âº ESO',
            'ALL': 'Sin Curso'
        };
        const label = map[code] || code;
        const color = code === 'ALL' ? '#94a3b8' : 'var(--primary-color)'; // Gray for ALL, Primary for others
        return `<span style="background: ${color}; color: white; padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.75rem; margin-right: 0.5rem;">${label}</span>`;
    }

    // --- Sub-user Logic ---
    async function loadSubUsers() {
        try {
            const response = await axios.get('/subusers/');
            const subusers = response.data;
            const container = document.getElementById('subusers-list');
            container.innerHTML = '';

            subusers.forEach(u => {
                const isActive = u.access_expires_at && new Date(u.access_expires_at) > new Date();
                const statusHtml = isActive
                    ? `<span style="color: #22c55e; font-size: 0.85rem; font-weight: 500;">Premium hasta ${new Date(u.access_expires_at).toLocaleDateString()}</span>`
                    : `<span style="color: #f59e0b; font-size: 0.85rem; font-weight: 500;">Acceso Limitado</span>`;

                const card = document.createElement('div');
                card.style.cssText = "border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background: #f8fafc;";
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0; font-size: 1.1rem;">${u.name}</h3>
                        ${statusHtml}
                    </div>
                    <button onclick="openSubUserLicenseModal(${u.id}, '${u.name}')" class="btn btn-outline" style="width: 100%; font-size: 0.85rem; padding: 0.4rem;">
                        ${isActive ? 'Extender Licencia' : 'Activar Licencia'}
                    </button>
                    <!-- Maybe Show Login Code if recently generated? No, requirement says generate once -->
                `;
                container.appendChild(card);
            });

            if (subusers.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1/-1; text-align: center;">No tienes sub-usuarios creados.</p>';
            }
        } catch (error) {
            console.error("Error loading subusers", error);
        }
    }

    // Modal helpers
    function openAddSubUserModal() { document.getElementById('add-subuser-modal').style.display = 'flex'; }
    function closeAddSubUserModal() { document.getElementById('add-subuser-modal').style.display = 'none'; }

    function openSubUserLicenseModal(id, name) {
        document.getElementById('target-subuser-id').value = id;
        document.getElementById('subuser-target-name').innerText = `Para: ${name}`;
        document.getElementById('subuser-license-modal').style.display = 'flex';
    }
    function closeSubUserLicenseModal() { document.getElementById('subuser-license-modal').style.display = 'none'; }

    function closeShowCodeModal() {
        document.getElementById('show-code-modal').style.display = 'none';
        loadSubUsers(); // Refresh status
    }

    // Event Listeners
    document.getElementById('add-subuser-modal').onclick = (e) => { if (e.target === document.getElementById('add-subuser-modal')) closeAddSubUserModal(); };
    document.getElementById('subuser-license-modal').onclick = (e) => { if (e.target === document.getElementById('subuser-license-modal')) closeSubUserLicenseModal(); };

    document.getElementById('add-subuser-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('subuser-name').value;
        try {
            await axios.post('/subusers/', { name: name });
            closeAddSubUserModal();
            loadSubUsers();
            document.getElementById('subuser-name').value = ''; // Reset
        } catch (error) {
            alert('Error: ' + (error.response?.data?.detail || "Error al crear sub-usuario"));
        }
    });

    document.getElementById('subuser-license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('target-subuser-id').value;
        const key = document.getElementById('subuser-license-key').value.trim();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.innerText = "Activando...";

        try {
            const response = await axios.post(`/subusers/${id}/license`, { license_key: key });

            // Success: Show code
            closeSubUserLicenseModal();
            document.getElementById('generated-code-display').innerText = response.data.login_code;
            document.getElementById('show-code-modal').style.display = 'flex';
            document.getElementById('subuser-license-key').value = ''; // Reset

        } catch (error) {
            alert('Error: ' + (error.response?.data?.detail || "Error al activar licencia"));
        } finally {
            btn.innerText = "Activar y Generar CÃ³digo";
        }
    });

    loadDashboard();
</script>
{% endblock %}