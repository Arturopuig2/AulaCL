{% extends "layout.html" %}

{% block navbar_actions %}
<a href="/dashboard" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">‚Üê Volver al panel</a>
{% endblock %}

{% block content %}
<div class="glass-panel" style="padding: 2rem; max-width: 1000px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>Administraci√≥n</h1>

    </div>

    <div
        style="margin-bottom: 3rem; background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); padding: 1.5rem; border-radius: 1rem; border: 1px solid #bfdbfe; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);">
        <h2
            style="margin-bottom: 1.5rem; color: #1e40af; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            ‚ú® Escritor M√°gico IA
            <span
                style="font-size: 0.8rem; background: #2563eb; color: white; padding: 2px 8px; border-radius: 12px; font-weight: normal;">Nuevo</span>
        </h2>

        <!-- MAGIC CONFIG -->
        <div id="magic-config">
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end;">
                <div class="form-group" style="grid-column: span 2;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Tema / Sinopsis</label>
                    <input type="text" id="magic-topic" placeholder="Ej: Dos astronautas descubren una flor en la Luna"
                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                </div>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Edad Lectores</label>
                    <input type="text" id="magic-age" placeholder="Ej: 8-10 a√±os"
                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                </div>

                <div class="form-group">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="magic-words">
                        Longitud (palabras) <span class="text-xs text-blue-500">(v1.5)</span>
                    </label>
                    <input type="number" id="magic-words" value="150" step="50"
                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                </div>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Idioma</label>
                    <select id="magic-lang"
                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                        <option value="es">Espa√±ol</option>
                        <option value="en">Ingl√©s</option>
                        <option value="val">Valenci√†</option>
                        <option value="fr">Franc√©s</option>
                    </select>
                </div>

                <div class="form-group">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Guardar en Curso</label>
                    <select id="magic-course"
                        style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                        <option value="ALL">Sin Curso / General</option>
                        <optgroup label="Primaria">
                            <option value="1P">1¬∫ P</option>
                            <option value="2P">2¬∫ P</option>
                            <option value="3P">3¬∫ P</option>
                            <option value="4P">4¬∫ P</option>
                            <option value="5P">5¬∫ P</option>
                            <option value="6P">6¬∫ P</option>
                        </optgroup>
                    </select>
                </div>

                <button onclick="generateMagicStory()" id="btn-magic-gen" class="btn btn-primary"
                    style="width: 100%; height: 42px; background: #2563eb;">
                    ü™Ñ Generar Cuento
                </button>
            </div>
        </div>

        <!-- MAGIC EDITOR -->
        <div id="magic-editor"
            style="display: none; margin-top: 2rem; border-top: 2px dashed #bfdbfe; padding-top: 2rem;">
            <h3 style="margin-bottom: 1rem; color: #1e40af;">Revisi√≥n y Edici√≥n</h3>

            <div class="form-group" style="margin-bottom: 1rem;">
                <label style="font-weight: bold;">T√≠tulo</label>
                <input type="text" id="edit-title"
                    style="width: 100%; padding: 0.5rem; font-weight: bold; font-size: 1.1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem;">
            </div>

            <div class="form-group" style="margin-bottom: 2rem;">
                <label style="font-weight: bold;">Historia</label>
                <textarea id="edit-content"
                    style="width: 100%; height: 300px; padding: 1rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; font-family: sans-serif; line-height: 1.6;"></textarea>
            </div>

            <h4 style="margin-bottom: 1rem; color: #1e40af;">Editar Preguntas</h4>
            <div id="questions-container" style="display: grid; gap: 1rem; margin-bottom: 2rem;">
                <!-- JS will popualte this -->
            </div>

            <div style="display: flex; gap: 1rem;">
                <button onclick="saveMagicStory()" id="btn-magic-save" class="btn btn-primary"
                    style="flex: 2; padding: 1rem; font-size: 1.1rem;">üíæ Guardar en Librer√≠a</button>
                <button onclick="cancelMagic()" class="btn btn-outline" style="flex: 1;">Cancelar</button>
            </div>
        </div>
    </div>

    <div <form id="upload-form"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end;">
        <div class="form-group" style="margin-bottom: 0;">
            <label for="new-title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">T√≠tulo</label>
            <input type="text" id="new-title" required
                style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="new-course" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Curso</label>
            <select id="new-course" required
                style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                <option value="" disabled selected>Seleccionar...</option>
                <optgroup label="Primaria">
                    <option value="1P">1¬∫ Primaria</option>
                    <option value="2P">2¬∫ Primaria</option>
                    <option value="3P">3¬∫ Primaria</option>
                    <option value="4P">4¬∫ Primaria</option>
                    <option value="5P">5¬∫ Primaria</option>
                    <option value="6P">6¬∫ Primaria</option>
                </optgroup>
                <optgroup label="ESO">
                    <option value="1ESO">1¬∫ ESO</option>
                    <option value="2ESO">2¬∫ ESO</option>
                    <option value="3ESO">3¬∫ ESO</option>
                    <option value="4ESO">4¬∫ ESO</option>
                </optgroup>
                <optgroup label="Bachillerato">
                    <option value="1BAT">1¬∫ Bachillerato</option>
                    <option value="2BAT">2¬∫ Bachillerato</option>
                </optgroup>
                <option value="ALL">Sin Curso / General</option>
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="new-lang" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Idioma</label>
            <select id="new-lang" required
                style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
                <option value="es" selected>Espa√±ol</option>
                <option value="val">Valenci√†</option>
                <option value="en">Ingl√©s</option>
                <option value="fr">Franc√©s</option>
                <option value="cat">Catal√†</option>
                <option value="gal">Gallego</option>
                <option value="eus">Euskera</option>
            </select>
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="text-file" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Archivo de Texto
                (.txt)</label>
            <input type="file" id="text-file" accept=".txt" required style="font-size: 0.9rem;">
        </div>

        <div class="form-group" style="margin-bottom: 0;">
            <label for="audio-file" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Audio (.mp3)
                (Opcional)</label>
            <input type="file" id="audio-file" accept=".mp3" style="font-size: 0.9rem;">
        </div>

        <div style="grid-column: 1 / -1;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">Subir Lectura</button>
        </div>
        </form>
    </div>

    <!-- ACCESS CODES SECTION -->
    <div
        style="margin-bottom: 3rem; background: white; padding: 1.5rem; border-radius: 1rem; border: 1px solid #e2e8f0;">
        <h2 style="margin-bottom: 1.5rem; color: var(--text-primary); font-size: 1.25rem;">Generar C√≥digos de Acceso
        </h2>
        <div style="display: flex; gap: 1rem; align-items: end; margin-bottom: 1.5rem;">
            <div style="flex: 1;">
                <label for="code-count"
                    style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Cantidad</label>
                <input type="number" id="code-count" value="1" min="1" max="50"
                    style="padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.5rem; width: 100%;">
            </div>
            <button onclick="generateCodes()" class="btn btn-primary" style="padding: 0.6rem 1.5rem;">Generar</button>
        </div>

        <h3 style="margin-bottom: 1rem; font-size: 1rem;">C√≥digos Existentes</h3>
        <div style="max-height: 200px; overflow-y: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                <thead style="position: sticky; top: 0; background: white;">
                    <tr style="border-bottom: 1px solid #e2e8f0; text-align: left;">
                        <th style="padding: 0.5rem;">C√≥digo</th>
                        <th style="padding: 0.5rem;">Estado</th>
                        <th style="padding: 0.5rem;">Usado por</th>
                        <th style="padding: 0.5rem;">Email</th>
                        <th style="padding: 0.5rem;">Fecha Uso</th>
                        <th style="padding: 0.5rem;">Caducidad</th>
                    </tr>
                </thead>
                <tbody id="codes-table-body">
                    <!-- Codes loaded via JS -->
                </tbody>
            </table>
        </div>
    </div>

    <div class="table-container" style="overflow-x: auto;">
        <h2 style="margin-bottom: 1rem; color: var(--text-primary); font-size: 1.25rem;">Gesti√≥n de Lecturas</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid #e2e8f0; text-align: left;">
                    <th style="padding: 1rem;">ID</th>
                    <th style="padding: 1rem;">T√≠tulo</th>
                    <th style="padding: 1rem;">Curso</th>
                    <th style="padding: 1rem;">Idioma</th>
                    <th style="padding: 1rem;">Estado</th>
                    <th style="padding: 1rem;">Acciones</th>
                </tr>
            </thead>
            <tbody id="texts-table-body">
                <!-- Rows loaded via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const courseOptions = [
        { value: 'ALL', label: 'Sin Curso' },
        { value: '1P', label: '1¬∫ Primaria' }, { value: '2P', label: '2¬∫ Primaria' },
        { value: '3P', label: '3¬∫ Primaria' }, { value: '4P', label: '4¬∫ Primaria' },
        { value: '5P', label: '5¬∫ Primaria' }, { value: '6P', label: '6¬∫ Primaria' },
        { value: '1ESO', label: '1¬∫ ESO' }, { value: '2ESO', label: '2¬∫ ESO' },
        { value: '3ESO', label: '3¬∫ ESO' }, { value: '4ESO', label: '4¬∫ ESO' },
        { value: '1BAT', label: '1¬∫ Bachillerato' }, { value: '2BAT', label: '2¬∫ Bachillerato' }
    ];

    const langOptions = [
        { value: 'es', label: 'Espa√±ol' }, { value: 'en', label: 'Ingl√©s' },
        { value: 'val', label: 'Valenci√†' }, { value: 'cat', label: 'Catal√†' },
        { value: 'gal', label: 'Gallego' }, { value: 'eus', label: 'Euskera' },
        { value: 'fr', label: 'Franc√©s' }
    ];

    async function loadAdmin() {
        const token = localStorage.getItem('token');
        const username = localStorage.getItem('username');

        if (!token || username !== 'admin') {
            window.location.href = '/dashboard';
            return;
        }

        axios.defaults.headers.common['Authorization'] = 'Bearer ' + token;

        try {
            const response = await axios.get('/reading/admin/texts');
            renderTable(response.data);

            // Load Codes
            loadCodes();
        } catch (error) {
            console.error(error);
            alert('Error cargando datos. Verifica si eres admin.');
        }
    }

    async function loadCodes() {
        try {
            const response = await axios.get('/auth/admin/codes');
            const tbody = document.getElementById('codes-table-body');
            tbody.innerHTML = '';

            // Sort: Unused first, then by creation date
            const codes = response.data.sort((a, b) => {
                if (a.is_used === b.is_used) return 0;
                return a.is_used ? 1 : -1;
            });

            codes.forEach(c => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f1f5f9';
                tr.innerHTML = `
                    <td style="padding: 0.5rem; font-family: monospace; font-weight: bold;">${c.code}</td>
                    <td style="padding: 0.5rem;">
                        ${c.is_used
                        ? '<span style="color: #ef4444; font-size: 0.8rem; background: #fee2e2; padding: 2px 6px; border-radius: 4px;">Usado</span>'
                        : '<span style="color: #22c55e; font-size: 0.8rem; background: #dcfce7; padding: 2px 6px; border-radius: 4px;">Disponible</span>'}
                    </td>
                    <td style="padding: 0.5rem; color: var(--text-primary); font-weight: 500;">
                        ${c.used_by || '-'}
                    </td>
                    <td style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                        ${c.user_email || '-'}
                    </td>
                    <td style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                        ${c.used_at ? new Date(c.used_at).toLocaleDateString() : '-'}
                    </td>
                    <td style="padding: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                        ${c.expires_at ? new Date(c.expires_at).toLocaleDateString() : '-'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Error loading codes", error);
        }
    }

    async function generateCodes() {
        const count = document.getElementById('code-count').value;
        try {
            const response = await axios.post(`/auth/admin/codes?count=${count}`);
            loadCodes();

            // Auto-Download Text File
            const codes = response.data;
            let fileContent = "C√ìDIGOS DE ACCESO - AULA CL\n===========================\n\n";
            fileContent += codes.join("\n");
            fileContent += "\n\n===========================\nGenerado el: " + new Date().toLocaleString();

            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `codigos_aulacl_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            alert(`¬°${count} c√≥digos generados y descargados!`);
        } catch (error) {
            console.error(error);
            alert('Error generando c√≥digos');
        }
    }

    function renderTable(texts) {
        const tbody = document.getElementById('texts-table-body');
        tbody.innerHTML = '';

        texts.forEach(text => {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #f1f5f9';
            tr.innerHTML = `
                <td style="padding: 1rem;">${text.id}</td>
                <td style="padding: 1rem; font-weight: 500;">${text.title}</td>
                <td style="padding: 1rem;">
                    <select id="course-${text.id}" style="padding: 0.3rem; border-radius: 0.3rem; border: 1px solid #cbd5e1;">
                        ${courseOptions.map(opt => `<option value="${opt.value}" ${opt.value === text.course_level ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>
                </td>
                <td style="padding: 1rem;">
                    <select id="lang-${text.id}" style="padding: 0.3rem; border-radius: 0.3rem; border: 1px solid #cbd5e1;">
                        ${langOptions.map(opt => `<option value="${opt.value}" ${opt.value === text.language ? 'selected' : ''}>${opt.label}</option>`).join('')}
                    </select>
                </td>
                <td style="padding: 1rem;">
                    <button 
                        onclick="toggleTextActive(${text.id}, this)"
                        class="btn"
                        style="padding: 0.3rem 0.8rem; font-size: 0.85rem; background: ${text.is_active ? '#eff6ff' : '#fef2f2'}; color: ${text.is_active ? '#3b82f6' : '#ef4444'}; border: 1px solid ${text.is_active ? '#bfdbfe' : '#fecaca'};"
                    >
                        ${text.is_active ? 'Activo' : 'Inactivo'}
                    </button>
                </td>
                <td style="padding: 1rem; display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="updateText(${text.id}, this)" style="padding: 0.3rem 0.8rem; font-size: 0.85rem;">Guardar</button>
                    <button class="btn" onclick="deleteText(${text.id})" style="padding: 0.3rem 0.8rem; font-size: 0.85rem; background: #fee2e2; color: #ef4444; border: 1px solid #fecaca;">Eliminar</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    async function toggleTextActive(id, btn) {
        try {
            const response = await axios.patch(`/reading/admin/texts/${id}/toggle`);
            const isActive = response.data.is_active;

            // Update button styles
            btn.innerText = isActive ? 'Activo' : 'Inactivo';
            btn.style.background = isActive ? '#eff6ff' : '#fef2f2';
            btn.style.color = isActive ? '#3b82f6' : '#ef4444';
            btn.style.borderColor = isActive ? '#bfdbfe' : '#fecaca';

        } catch (error) {
            console.error(error);
            alert('Error cambiando estado: ' + (error.response?.data?.detail || error.message));
        }
    }

    async function deleteText(id) {
        if (!confirm('¬øEst√°s seguro de que quieres eliminar esta lectura? Esta acci√≥n no se puede deshacer.')) {
            return;
        }

        try {
            await axios.delete(`/reading/admin/texts/${id}`);
            // Remove from UI immediately or reload
            loadAdmin();
        } catch (error) {
            console.error(error);
            alert('Error eliminando lectura: ' + (error.response?.data?.detail || error.message));
        }
    }

    async function updateText(id, btn) {
        const course = document.getElementById(`course-${id}`).value;
        const lang = document.getElementById(`lang-${id}`).value;

        // Visual feedback - Loading
        const originalText = btn.innerText;
        const originalColor = btn.style.backgroundColor;
        btn.innerText = "Guardando...";
        btn.disabled = true;

        try {
            await axios.put(`/reading/admin/texts/${id}`, {
                course_level: course,
                language: lang
            });

            // Visual feedback - Success
            btn.innerText = "¬°Guardado!";
            btn.style.backgroundColor = "#22c55e";

            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = originalColor || "var(--primary-color)";
                btn.disabled = false;
            }, 2000);

        } catch (error) {
            console.error(error);
            alert('Error guardando: ' + (error.response?.data?.detail || error.message));
            btn.innerText = "Error";
            btn.style.backgroundColor = "#ef4444";
            btn.disabled = false;
        }
    }

    document.getElementById('upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        const originalText = btn.innerText;
        btn.innerText = "Subiendo...";
        btn.disabled = true;

        const formData = new FormData();
        formData.append('title', document.getElementById('new-title').value);
        formData.append('course_level', document.getElementById('new-course').value);
        formData.append('language', document.getElementById('new-lang').value);
        formData.append('text_file', document.getElementById('text-file').files[0]);

        const audioFile = document.getElementById('audio-file').files[0];
        if (audioFile) {
            formData.append('audio_file', audioFile);
        }

        try {
            await axios.post('/reading/admin/upload', formData, {
                headers: {
                    'Content-Type': 'multipart/form-data'
                }
            });

            alert('¬°Lectura subida correctamente!');
            e.target.reset();
            loadAdmin(); // Reload table

        } catch (error) {
            console.error(error);
            alert('Error subiendo lectura: ' + (error.response?.data?.detail || error.message));
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    });

    // --- MAGIC WRITER LOGIC ---
    let currentMagicDraft = null;

    async function generateMagicStory() {
        const topic = document.getElementById('magic-topic').value;
        const age = document.getElementById('magic-age').value;
        const words = document.getElementById('magic-words').value;
        const lang = document.getElementById('magic-lang').value;

        if (!topic || !age) {
            alert("Por favor, rellena el tema y la edad.");
            return;
        }

        const btn = document.getElementById('btn-magic-gen');
        const originalText = btn.innerText;
        btn.innerText = "‚ú® Creando Magia... (aprox 10s)";
        btn.disabled = true;

        try {
            const response = await axios.post('/reading/admin/magic/generate', {
                topic: topic,
                age_target: age,
                word_count: parseInt(words),
                language: lang
            });

            currentMagicDraft = response.data;
            console.log("Magic Draft Received:", currentMagicDraft); // Debug Log
            renderMagicEditor(currentMagicDraft);

            // UI Switch
            document.getElementById('magic-config').style.display = 'none';
            document.getElementById('magic-editor').style.display = 'block';

        } catch (error) {
            console.error(error);
            alert("Error generando cuento: " + (error.response?.data?.detail || error.message));
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function renderMagicEditor(draft) {
        console.log("Rendering Draft:", draft); // Debugging
        document.getElementById('edit-title').value = draft.title;
        document.getElementById('edit-content').value = draft.content;

        const qContainer = document.getElementById('questions-container');
        qContainer.innerHTML = '';

        draft.questions.forEach((q, index) => {
            const card = document.createElement('div');
            card.style.background = '#f8fafc';
            card.style.padding = '1rem';
            card.style.border = '1px solid #e2e8f0';
            card.style.borderRadius = '0.5rem';

            // Generate HTML structure (values set via JS below for safety)
            card.innerHTML = `
                <div style="margin-bottom: 0.5rem; font-weight: bold; color: #475569;">Pregunta ${index + 1}</div>
                <input type="text" class="q-input" style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #94a3b8; border-radius: 4px; color: #1e293b; background: #ffffff;">
                
                <div style="display: grid; gap: 0.5rem; padding-left: 1rem;">
                    ${q.options.map((_, optIndex) => `
                        <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: space-between;">
                            <input type="text" class="q-opt-input" data-q="${index}" data-opt="${optIndex}" placeholder="Escribe una opci√≥n..." style="flex: 1; padding: 0.5rem; border: 1px solid #94a3b8; border-radius: 4px; color: #1e293b; background: #ffffff; min-width: 0; margin-right: 0.5rem;">
                            <input type="radio" name="q-correct-${index}" value="${optIndex}" ${q.correct_index === optIndex ? 'checked' : ''} style="width: 24px; height: 24px; flex-shrink: 0; cursor: pointer;">
                        </div>
                    `).join('')}
                </div>
            `;

            // Set values safely via DOM properties (avoids all escaping issues)
            card.querySelector('.q-input').value = q.question;
            const optInputs = card.querySelectorAll('.q-opt-input');
            q.options.forEach((opt, i) => {
                const safeOpt = (opt === null || opt === undefined) ? "" : opt;
                if (optInputs[i]) optInputs[i].value = safeOpt;
            });

            qContainer.appendChild(card);
        });
    }

    async function saveMagicStory() {
        if (!currentMagicDraft) return;

        const btn = document.getElementById('btn-magic-save');
        btn.innerText = "Guardando...";
        btn.disabled = true;

        try {
            // 1. Collect Data
            const title = document.getElementById('edit-title').value;
            const content = document.getElementById('edit-content').value;
            const course = document.getElementById('magic-course').value;
            const lang = document.getElementById('magic-lang').value;

            // 2. Reconstruct Questions
            const questions = [];
            const qContainer = document.getElementById('questions-container');

            // Loop by children count
            for (let i = 0; i < qContainer.children.length; i++) {
                const card = qContainer.children[i];
                const qText = card.querySelector('.q-input').value;

                // Get options
                const optInputs = card.querySelectorAll('.q-opt-input');
                const options = Array.from(optInputs).map(input => input.value);

                // Get checked radio
                const checkedRadio = card.querySelector(`input[name="q-correct-${i}"]:checked`);
                const correctIndex = checkedRadio ? parseInt(checkedRadio.value) : 0;

                questions.push({
                    question: qText,
                    options: options,
                    correct_index: correctIndex
                });
            }

            // 3. Send API
            await axios.post('/reading/admin/magic/save', {
                title: title,
                content: content,
                questions: questions,
                course_level: course,
                language: lang
            });

            alert("¬°Cuento guardado correctamente! üìö");
            cancelMagic(); // Reset UI
            loadAdmin(); // Reload table

        } catch (error) {
            console.error(error);
            alert("Error guardando: " + (error.response?.data?.detail || error.message));
        } finally {
            btn.innerText = "üíæ Guardar en Librer√≠a";
            btn.disabled = false;
        }
    }

    function cancelMagic() {
        document.getElementById('magic-config').style.display = 'block';
        document.getElementById('magic-editor').style.display = 'none';
        currentMagicDraft = null;
        document.getElementById('edit-title').value = '';
        document.getElementById('edit-content').value = '';
        document.getElementById('questions-container').innerHTML = '';
    }

    loadAdmin();
</script>
{% endblock %}